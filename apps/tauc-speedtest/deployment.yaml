apiVersion: apps/v1
kind: Deployment
metadata:
  name: tauc-speedtest
  namespace: $(NAMESPACES_APPLICATIONS)
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tauc-speedtest
  template:
    metadata:
      labels:
        app: tauc-speedtest
    spec:
      securityContext:
        fsGroup: 101   # nginx user in alpine image
      initContainers:
        - name: init-downloads
          image: alpine:3.20
          command: ["/bin/sh","-c"]
          args:
            - |
              set -e
              mkdir -p /var/www/downloads /var/www/uploads
              # generate 20MB test file
              dd if=/dev/zero of=/var/www/downloads/20MB.file bs=1M count=20
              # make sure nginx (uid 101) can read/write
              chown -R 101:101 /var/www/downloads /var/www/uploads
          volumeMounts:
            - name: downloads
              mountPath: /var/www/downloads
            - name: uploads
              mountPath: /var/www/uploads
      containers:
        - name: nginx
          image: nginx:1.27-alpine
          ports:
            - containerPort: 80
              name: http
          readinessProbe:
            httpGet:
              path: /downloads/20MB.file
              port: 80
            initialDelaySeconds: 2
            periodSeconds: 5
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
            - name: downloads
              mountPath: /var/www/downloads
            - name: uploads
              mountPath: /var/www/uploads
      volumes:
        - name: nginx-conf
          configMap:
            name: tauc-nginx-conf
        - name: downloads
          emptyDir: {}          # ephemeral; regenerated each pod start
        - name: uploads
          persistentVolumeClaim:
            claimName: tauc-uploads
